name: CI

# ↓ lock down top‐level permissions. Define all permissions at job level
permissions: {}

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  install-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read             # we only need to checkout code
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  #v6.0.2

      - name: Prefer Google mirror globally
        run: |
          echo '{"registry-mirrors":["https://mirror.gcr.io"]}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker

      - name: Setup Compact Compiler
        uses: midnightntwrk/setup-compact-action@836895c8fffbbea6bd986af2b17e8941ff29d1f8
        with:
          compact-version: '0.28.0'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Compile and test contract
        working-directory: contract
        run: |
          bun run lint
          bun run compact
          bun run typecheck
          bun run build
          bun run test

      - name: Compile donation-cli
        working-directory: donation-cli
        run: |
          bun run lint
          bun run typecheck
          bun run build
          bun run test-api
